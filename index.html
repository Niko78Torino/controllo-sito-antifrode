<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URLGuard Web</title>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8268426852108056"
     crossorigin="anonymous"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .highlight { color: #EF4444; font-weight: 700; }
    </style>
</head>
<body class="bg-sky-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <div class="bg-white p-8 rounded-2xl shadow-lg">
            
            <!-- Intestazione -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">üîê URLGuard Web</h1>
                <p class="text-gray-500 mt-2">Analisi avanzata di URL: et√† del dominio, URL abbreviati, phishing e geolocalizzazione IP.</p>
            </div>

            <!-- Form di inserimento URL -->
            <form id="url-form" onsubmit="handleFormSubmit(event)">
                <div class="relative">
                    <input type="text" id="url-input" name="url" class="w-full px-4 py-3 bg-gray-100 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="https://esempio.com o http://bit.ly/..." required>
                    <button type="button" id="paste-button" title="Incolla e Analizza" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-500 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 mt-3">
                    <button type="submit" id="analyze-button" class="w-full sm:w-auto flex-grow bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-transform transform hover:scale-105 flex items-center justify-center">
                        <span id="button-text">Analizza</span>
                        <svg id="button-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <button type="button" id="reset-button" class="w-full sm:w-auto bg-gray-500 text-white font-semibold px-6 py-3 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition-transform transform hover:scale-105">
                        Reset
                    </button>
                </div>
            </form>
            
            <!-- Area di notifica -->
            <div id="notification-area" class="text-center text-sm text-gray-600 mt-2 h-5"></div>

            <!-- Esempi di URL -->
            <div class="text-center text-sm text-gray-500 mt-4">
                <span>Prova con:</span>
                <a href="#" class="example-url text-blue-500 hover:underline" data-url="https://google.com">sicuro</a>,
                <a href="#" class="example-url text-blue-500 hover:underline" data-url="http://8.8.8.8">IP</a>,
                <a href="#" class="example-url text-blue-500 hover:underline" data-url="https://my-account-update-paypal.com/login">phishing</a>
            </div>

            <!-- Sezione dei risultati (inizialmente nascosta) -->
            <div id="results-container" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-900">Risultati dell'Analisi</h2>
                <div id="risk-score-container" class="mb-6"></div>
                <div id="url-details-container" class="space-y-4"></div>
                <div id="reasons-list-container" class="mt-4 hidden"></div>
                <div id="location-info-container" class="mt-4 hidden"></div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="text-center mt-8 pt-6 border-t border-gray-200 text-sm text-gray-500">
            <p class="mb-2">¬© 2025 Nicola Nicolaci. Tutti i diritti riservati.</p>
            <p class="mb-4">Questo strumento rispetta la tua privacy: nessun dato sensibile viene raccolto o memorizzato.</p>
            <p class="mb-3">Se trovi utile questo strumento, considera di supportare lo sviluppo di futuri progetti di utilit√† comune.</p>
            <a href="https://buy.stripe.com/dRm00lakN8tm5x6fJUdjO04" target="_blank" rel="noopener noreferrer" class="inline-block bg-white text-gray-800 font-semibold px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors shadow-sm">
                Fai una Donazione con Stripe
            </a>
        </footer>
    </div>

    <script>
        // --- SELETTORI DOM ---
        const urlForm = document.getElementById('url-form');
        const urlInput = document.getElementById('url-input');
        const analyzeButton = document.getElementById('analyze-button');
        const resetButton = document.getElementById('reset-button');
        const pasteButton = document.getElementById('paste-button');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        const resultsContainer = document.getElementById('results-container');
        const riskScoreContainer = document.getElementById('risk-score-container');
        const urlDetailsContainer = document.getElementById('url-details-container');
        const reasonsListContainer = document.getElementById('reasons-list-container');
        const locationInfoContainer = document.getElementById('location-info-container');
        const notificationArea = document.getElementById('notification-area');
        const exampleUrlLinks = document.querySelectorAll('.example-url');

        // --- FUNZIONE DI NOTIFICA ---
        function showNotification(message, isError = false, duration = 4000) {
            notificationArea.textContent = message;
            notificationArea.className = `text-center text-sm mt-2 h-5 ${isError ? 'text-red-600' : 'text-gray-600'}`;
            if (duration > 0) {
                setTimeout(() => { notificationArea.textContent = ''; }, duration);
            }
        }

        // --- FUNZIONE DI ANALISI PRINCIPALE ---
        async function analyzeUrl(initialUrl) {
            const result = {
                original_url: initialUrl,
                final_url: initialUrl,
                score: 0,
                reasons: [],
                highlights: new Set(),
                location: null,
                domain_age_days: null
            };

            const shortenerDomains = ['bit.ly', 't.co', 'goo.gl', 'tinyurl.com', 'is.gd', 'buff.ly', 'adf.ly'];
            const suspiciousWords = ["login", "secure", "update", "verify", "account", "bank", "paypal", "signin", "conferma", "webscr"];
            
            let currentUrl = initialUrl;

            // Controllo URL abbreviato
            try {
                const parsedForShortener = new URL(currentUrl);
                if (shortenerDomains.some(d => parsedForShortener.hostname.endsWith(d))) {
                    showNotification("Rilevato URL abbreviato, espansione in corso...", false, 0);
                    result.score += 15;
                    result.reasons.push("L'uso di un URL abbreviato nasconde la destinazione finale (+15)");
                    try {
                        const response = await fetch(`https://corsproxy.io/?${encodeURIComponent('https://unshorten.it/json/' + currentUrl)}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.unshortened_url) {
                                currentUrl = data.unshortened_url;
                                result.final_url = currentUrl;
                            } else {
                                throw new Error('API unshorten.it non ha risolto l\'URL.');
                            }
                        } else {
                           throw new Error(`Errore di rete (${response.status}) nel contattare il servizio di espansione.`);
                        }
                    } catch (e) {
                        console.error("Errore espansione URL:", e);
                        result.score += 30;
                        result.reasons.push("Impossibile espandere l'URL abbreviato, analisi parziale (+30)");
                    }
                }
            } catch (e) { /* Formato URL non valido, verr√† gestito dopo */ }
            
            result.final_url = currentUrl;
            showNotification("Analisi in corso...", false, 0);

            // 1. Lunghezza URL
            if (currentUrl.length > 75) {
                result.score += 15;
                result.reasons.push("URL lungo, potrebbe nascondere informazioni (+15)");
            }

            // 2. Caratteri sospetti
            const suspiciousChars = Array.from(currentUrl.matchAll(/@|%|--|\.\.|(?<!:)\/\//g)).map(m => m[0]);
            if (suspiciousChars.length > 0) {
                const uniqueChars = [...new Set(suspiciousChars)];
                result.score += 25 * uniqueChars.length;
                result.reasons.push(`Contiene caratteri sospetti: ${uniqueChars.join(', ')} (+${25 * uniqueChars.length})`);
                uniqueChars.forEach(c => result.highlights.add(c));
            }

            // 3. Parole chiave sospette
            suspiciousWords.forEach(word => {
                if (currentUrl.toLowerCase().includes(word)) {
                    result.score += 20;
                    result.reasons.push(`Contiene la parola chiave sospetta: "${word}" (+20)`);
                    result.highlights.add(word);
                }
            });
            
            // 4. Analisi Dominio
            try {
                const parsedUrl = new URL(currentUrl);
                const domain = parsedUrl.hostname;

                // Controllo se √® un indirizzo IP
                if (/^\d{1,3}(\.\d{1,3}){3}$/.test(domain)) {
                    result.score += 40;
                    result.reasons.push("Utilizza un indirizzo IP al posto del dominio (+40)");
                    result.highlights.add(domain);
                    showNotification("Geolocalizzazione IP in corso...", false, 0);
                    try {
                        const response = await fetch(`https://ip-api.com/json/${domain}`);
                        if (response.ok) {
                            result.location = await response.json();
                        }
                    } catch (error) { console.error("Errore Geolocalizzazione:", error); }
                } else {
                    // Controllo et√† del dominio (RDAP)
                    showNotification("Verifica et√† dominio in corso (RDAP)...", false, 0);
                    try {
                        const rdapResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent('https://rdap.org/domain/' + domain)}`);
                        if (rdapResponse.ok) {
                            const rdapData = await rdapResponse.json();
                            const registrationEvent = rdapData.events?.find(e => e.eventAction === 'registration');
                            if (registrationEvent?.eventDate) {
                                const creationDate = new Date(registrationEvent.eventDate);
                                const ageDays = (new Date() - creationDate) / (1000 * 60 * 60 * 24);
                                result.domain_age_days = Math.floor(ageDays);
                                if (ageDays < 30) {
                                    result.score += 50;
                                    result.reasons.push(`Dominio molto recente (${result.domain_age_days} giorni) - Rischio Critico (+50)`);
                                } else if (ageDays < 180) {
                                    result.score += 30;
                                    result.reasons.push(`Dominio recente (${result.domain_age_days} giorni) - Rischio Alto (+30)`);
                                } else if (ageDays < 365) {
                                    result.score += 15;
                                    result.reasons.push(`Dominio registrato da meno di un anno (${result.domain_age_days} giorni) (+15)`);
                                }
                            } else {
                                result.reasons.push("Impossibile determinare l'et√† del dominio (dati di registrazione non presenti).");
                            }
                        } else if (rdapResponse.status === 404) {
                            // Gestisce il caso in cui il dominio non viene trovato su RDAP, che non √® un errore
                            result.reasons.push("Nessuna informazione di registrazione trovata per questo dominio.");
                        } else {
                           // Gestisce altri errori HTTP come un fallimento del servizio
                           throw new Error(`Il servizio RDAP ha risposto con un errore: ${rdapResponse.status}`);
                        }
                    } catch (e) { 
                        console.error("Errore durante la chiamata RDAP:", e);
                        result.reasons.push("La verifica dell'et√† del dominio non √® riuscita (errore di rete).");
                    }
                }
                
                // Controllo Punycode
                if (domain.startsWith('xn--')) {
                    result.score += 50;
                    result.reasons.push("Dominio utilizza Punycode (potenziale attacco omografo) (+50)");
                    result.highlights.add(domain);
                }

            } catch (e) {
                result.score += 50;
                result.reasons.push("L'URL non √® formattato correttamente (+50)");
            }

            result.score = Math.min(result.score, 100);
            showNotification("");
            return result;
        }

        // --- FUNZIONI DI VISUALIZZAZIONE ---
        function displayResults(analysis) {
            displayRiskScore(analysis.score);

            let urlHtml = `
                <div class="mb-4">
                    <p class="font-medium">URL Finale Analizzato:</p>
                    <p class="text-gray-700 bg-gray-50 p-3 rounded-lg break-all">${highlightUrl(analysis.final_url, analysis.highlights)}</p>
                </div>
            `;
            if (analysis.original_url !== analysis.final_url) {
                urlHtml += `
                <div class="mb-4">
                    <p class="font-medium">URL Originale (abbreviato):</p>
                    <p class="text-gray-700 bg-gray-50 p-3 rounded-lg break-all">${highlightUrl(analysis.original_url, new Set())}</p>
                </div>`;
            }
            urlDetailsContainer.innerHTML = urlHtml;

            reasonsListContainer.innerHTML = '';
            if (analysis.reasons.length > 0) {
                let reasonsHtml = '<p class="font-medium">Dettagli Rilevati:</p><ul class="list-disc list-inside mt-2 space-y-2 text-gray-700">';
                if (analysis.domain_age_days !== null) {
                    reasonsHtml += `<li>Et√† del dominio: <strong>${analysis.domain_age_days} giorni</strong></li>`;
                }
                analysis.reasons.forEach(reason => {
                    reasonsHtml += `<li>${reason}</li>`;
                });
                reasonsHtml += '</ul>';
                reasonsListContainer.innerHTML = reasonsHtml;
                reasonsListContainer.classList.remove('hidden');
            } else {
                 reasonsListContainer.classList.add('hidden');
            }
            
            locationInfoContainer.innerHTML = '';
            locationInfoContainer.classList.add('hidden');
            if (analysis.location && analysis.location.status === 'success') {
                locationInfoContainer.innerHTML = `
                    <p class="font-medium">Informazioni di Geolocalizzazione IP:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-gray-700 bg-gray-50 p-4 rounded-lg border">
                        <li><strong>Paese:</strong> ${analysis.location.country || 'Non disponibile'}</li>
                        <li><strong>Citt√†:</strong> ${analysis.location.city || 'Non disponibile'}</li>
                        <li><strong>Provider (ISP):</strong> ${analysis.location.isp || 'Non disponibile'}</li>
                    </ul>
                `;
                locationInfoContainer.classList.remove('hidden');
            }

            resultsContainer.classList.remove('hidden');
        }
        
        function highlightUrl(url, highlights) {
            let highlighted = url;
            const sortedHighlights = Array.from(highlights).sort((a, b) => b.length - a.length);
            sortedHighlights.forEach(part => {
                const regex = new RegExp(part.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                highlighted = highlighted.replace(regex, `<span class="highlight">$&</span>`);
            });
            return highlighted;
        }

        function displayRiskScore(score) {
            let level, color, textColor;
            if (score <= 20) { level = 'Basso'; color = 'bg-green-500'; textColor = 'text-green-800'; } 
            else if (score <= 50) { level = 'Medio'; color = 'bg-yellow-500'; textColor = 'text-yellow-800'; }
            else if (score <= 80) { level = 'Alto'; color = 'bg-orange-500'; textColor = 'text-orange-800'; }
            else { level = 'Critico'; color = 'bg-red-500'; textColor = 'text-red-800'; }

            riskScoreContainer.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <p class="font-medium">Livello di Rischio: <span class="font-bold ${textColor}">${level}</span></p>
                    <p class="font-semibold text-lg ${textColor}">${score} / 100</p>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4"><div class="${color} h-4 rounded-full" style="width: ${score}%"></div></div>`;
        }
        
        // --- GESTORI DI EVENTI ---
        async function handleFormSubmit(event) {
            if(event) event.preventDefault();
            let url = urlInput.value.trim();
            if (!url) {
                showNotification('Per favore, inserisci un URL.', true);
                return;
            }

            setLoadingState(true);
            resultsContainer.classList.add('hidden'); 

            if (!/^(https?:\/\/)/i.test(url)) {
                url = 'https://' + url;
            }

            const analysis = await analyzeUrl(url);
            displayResults(analysis);
            setLoadingState(false);
        }
        
        function handleReset() {
            urlInput.value = '';
            resultsContainer.classList.add('hidden');
            notificationArea.textContent = '';
            urlInput.focus();
        }

        async function handlePaste() {
            try {
                if (navigator.clipboard && navigator.clipboard.readText) {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        urlInput.value = text;
                        await handleFormSubmit();
                    }
                } else {
                    urlInput.focus();
                    if (document.execCommand('paste')) {
                        await handleFormSubmit();
                    } else {
                        showNotification('Incolla manualmente l\'URL nel campo di testo.', true);
                    }
                }
            } catch (err) {
                console.error('Impossibile leggere dagli appunti: ', err);
                showNotification('La funzione Incolla potrebbe non essere permessa. Incolla manualmente.', true);
            }
        }

        function handleExampleClick(event) {
            event.preventDefault();
            const url = event.target.dataset.url;
            if (url) {
                urlInput.value = url;
                handleFormSubmit();
            }
        }

        function setLoadingState(isLoading) {
            buttonText.classList.toggle('hidden', isLoading);
            buttonSpinner.classList.toggle('hidden', !isLoading);
            analyzeButton.disabled = isLoading;
            resetButton.disabled = isLoading;
            pasteButton.disabled = isLoading;
            urlInput.disabled = isLoading;
        }

        // --- COLLEGAMENTO EVENTI ---
        urlForm.addEventListener('submit', handleFormSubmit);
        resetButton.addEventListener('click', handleReset);
        pasteButton.addEventListener('click', handlePaste);
        exampleUrlLinks.forEach(link => link.addEventListener('click', handleExampleClick));
    </script>

</body>
</html>
